name: Build the site
on:
  workflow_dispatch:
  push:
     branches:
       - master
jobs:
   Jekyll:
     runs-on: ubuntu-latest
     steps:
         - name: Checkout the Code
           uses: actions/checkout@v2
           with:
             fetch-depth: 0
         - name: Normalize Unicode in the Previous Commit
           uses: buddhist-uni/normalized-unicode-action@v0.3
         - name: Install build requirements
           uses: ruby/setup-ruby@v1
           with:
             ruby-version: 3.1
             bundler-cache: true
         - name: Build the site
           run: |
            BUILD_DIR="${GITHUB_WORKSPACE}/../jekyll_build"
            mkdir $BUILD_DIR
            cd $GITHUB_WORKSPACE
            HASH="$(git log -n 1 --format=%H)"
            echo "Building $HASH into $BUILD_DIR ..."
            JEKYLL_ENV=production bundle exec jekyll build -d $BUILD_DIR
            cd $BUILD_DIR
            touch .nojekyll
            git init -b temp
            git config user.name "OBU Build Bot"
            git config user.email "buddhist-uni@users.noreply.github.com"
            git add .
            git commit -m "Automated GitHub build from ${HASH}" --quiet
            git push --force "https://buddhist-uni:${{ secrets.BUILD_ACTION_TOKEN }}@github.com/buddhist-uni/buddhist-uni.github.io.git" temp:prod
