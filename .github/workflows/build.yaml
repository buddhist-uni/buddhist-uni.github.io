name: Build
on:
  workflow_dispatch:
  push:
     branches:
       - master
jobs:
   Jekyll:
     runs-on: ubuntu-latest
     env:
         YJIT: ${{ endswith(github.run_number,'0') || endswith(github.run_number,'3') || endswith(github.run_number,'6') }}
         TRUFFLEVM: ${{ endswith(github.run_number,'1') || endswith(github.run_number,'7') }}
         TRUFFLE: ${{ endswith(github.run_number,'2') || endswith(github.run_number,'4') || endswith(github.run_number,'9') }}
     steps:
         - name: Print Env Vars
           run: |
             echo "YJIT=${{ env.YJIT }}"
             echo "TRUFFLE=${{ env.TRUFFLE }}"
         - name: Checkout the Code
           uses: actions/checkout@v3
           with:
             fetch-depth: 0
         - name: Normalize Unicode in the Previous Commit
           uses: buddhist-uni/normalized-unicode-action@v0.3
         - name: Install node
           uses: actions/setup-node@v3
           with:
             node-version: 18.7
             cache: 'npm'
             cache-dependency-path: 'package-lock.json'
         - run: npm ci
         - run: bash ./scripts/install-deps.bash
         - name: Install build requirements
           if: ${{ env.TRUFFLE == 'false' && env.TRUFFLEVM == 'false' }}
           uses: ruby/setup-ruby@v1
           with:
             ruby-version: 3.1
             bundler-cache: true
         - name: Install really fancy build requirements
           if: ${{ env.TRUFFLEVM == 'true' }}
           uses: ruby/setup-ruby@v1
           with:
             ruby-version: truffleruby+graalvm
             bundler-cache: true
         - name: Install fancy build requirements
           if: ${{ env.TRUFFLE == 'true' }}
           uses: ruby/setup-ruby@v1
           with:
             ruby-version: truffleruby
             bundler-cache: true
         - name: Build the site
           run: |
            BUILD_DIR="${GITHUB_WORKSPACE}/../jekyll_build"
            mkdir $BUILD_DIR
            cd $GITHUB_WORKSPACE
            HASH="$(git log -n 1 --format=%H)"
            echo "Building $HASH into $BUILD_DIR with:"
            if $YJIT; then  export RUBYOPT="--enable=yjit"; fi
            ruby --version
            JEKYLL_ENV=production bundle exec jekyll build -d $BUILD_DIR --trace
            echo "Purging unused css..."
            shopt -s globstar
            npx purgecss -v --content $BUILD_DIR/**/*.html $BUILD_DIR/assets/js/*.js --css $BUILD_DIR/assets/css/main.css -o $BUILD_DIR/assets/css/purged-main.css
            test -s $BUILD_DIR/assets/css/purged-main.css
            echo "Build complete. Pushing to prod branch..."
            cd $BUILD_DIR
            touch .nojekyll
            git init -b temp
            git config user.name "OBU Build Bot"
            git config user.email "buddhist-uni@users.noreply.github.com"
            git add .
            git commit -m "Automated GitHub build from ${HASH}" --quiet
            git push --force "https://buddhist-uni:${{ secrets.BUILD_ACTION_TOKEN }}@github.com/buddhist-uni/buddhist-uni.github.io.git" temp:prod
